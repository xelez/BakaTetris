# Описание API и протоколов взаимодействия

TODO: добавить нормальное обоснование выбора.

## клиент <-> сервис поиска (UDP Multicast/Broadcast)
Multicast/Broadcast - единственный простой способ найти сервера в локальной сети, не имея их точного ip-адреса. Это справедливо при условии, что мы не контролируем DNS/DHCP сервера в сети, что подразумевается.

Клиент отправляет "hello" серверу, слушающему на Multicast-адресе и
на Broadcast-адреса всех сетевых интерфейсов. Сервер отправляет обратно
список серверов лобби вида "ip1:port1;ip2:port2;...;ipN:portN".

## Описание HTTP REST-api сервера "лобби"
REST был выбран в следствие таких свойств как инициирование взаимодействия клиентом, отсутствие состояния и единообразие.
Также он базируется на основе открытых технологий и стандартов, поэтому легко может быть интегрирован с другими решениями. Это выгодно отличает его
от других возможных вариантов, таких как, например, WebServices и WCF.
Также из преимуществ REST - возможность использования в браузере, что
будет актуально при появление веб-версии клиента.

Успешность вызова определяется кодом возврата:

 * 400 - Bad Request - неверный запрос;
 * 403 - Forbidden - нет прав;
 * 404 - Not Found - такого объекта нет;
 * 200 - Ok - запрос выполнен.

| path           | method | параметры      | возвращает                                                |
|----------------|--------|----------------|-----------------------------------------------------------|
| /signup        | POST   | user, password | auth_token                                                |
| /signin        | POST   | user, password | auth_token                                                |
| /games         | GET    | auth_token     | список всех игр (нужно ли?)                               |
| /games/open    | GET    | auth_token     | список игр, к которым можно присоедениться                |
| /games         | POST   | auth_token     | game_id(id  новой игры), server_ip, create_token |


Параметры передаются через json, возвращается опять же json.

Пример списка игр, к которым можно присоедениться:

```javascript
[
    {
        id: "someid1", // mongodb ObjectId probably, but i'm not sure
        creator: "user1", // unicode!
        server_ip: "127.0.1.1:22222",
        join_token: "abracadabra" // about 16 random alphanumeric characters
    },
    {
        id: "someid2",
        creator: "юзер2",
        server_ip: "127.0.1.2:22223",
        join_token: "abacabacaca"
    }
]

```

В `auth_token` шифруется информация об имени пользователя, для чего выдан токен, кем выдан и т.п. Токен подписывается при помощи ключа сервера.
Клиент не должен и не может расшифровать токен, только использовать по назначению.

`create_game_token` и `join_token` -- строки из 16 случайных букв и цифр. Генерируются игровым сервером, передаются в лобби сервера через RabbitMQ.

## Описание отправляемых и принимаемых сообщений RabbitMQ

Очереди сообщений были выбраны для обеспечения взаимодействия между сервервами в следствие необходимости в надеждном способе асинхронного одностороннего взаимодействия между заранее неопределенным количеством
серверов и распределения загрузки по ним.

### Очередь "game_info"

![game_info](docs/game_info.png)

Очередь с подтверждениями обработки сообщений.
В неё игровые сервера посылают сообщения и они равномерно распределяются между серверами lobby.

Сообщения:

1. Первый игрок присоединился (`msgType = "owner_connected"`).

```json
{
    "game_id" : "asdfdsaf",
}
```

2. В игру зашел 2ой игрок, игра началась (`msgType = "opponent_connected"`).

```json
{
    "game_id" : "asdfdsaf",
    "opponent" : "user",
}
```

3. Игра завершена с таким-то результатом (`msgType = "game_ended"`).

```json
{
    "game_id" : "asdfdsaf",
    "winner" : "user",
}
```

### Очередь "rpc_queue"

![rpc_queue](docs/rpc_queue.png)

Предназначена для поиска и назначения игровых серверов.

Запрос:

```json
{
    "game_id" : "abacacba"
}
```

Ответ:

```json
{
    "server_ip" : "127.0.1.1:2222",
    "create_token" : "abacabadadb",
    "join_token"   : "murmurmaumau"
}
```

## Websockets

Для взаимодействия между клиентом и игровым сервером необходим быстрый,
асинхронный протокол, позволяющий инициировать отправку данных как клиентом, так и сервером. WebSockets выбран вместо TCP-сокетов в следствие
возможности использования из браузера, что будет преимуществом при
необходимости реализации веб-клиента в дальнейшем.

Посылаемые сообщения.

От сервера клиентам:

 1. Игра началась

    ```json
    {
        "msg_type" : "opponent_connected",
        "opponent": "user"
    }
    ```

От клиента к серверу:

 1. Аутентификация и авторизация:

    ```json
    {
        "msg_type"   : "handshake",
        "auth_token" : "asdfdsafdsafadsf",
        "game_id"    : "dfdfdfdf",
        "game_token" : "hgkgkgkhgut676",
    }
    ```

 2. "Я проиграл"

    ```json
    {
        "msg_type" : "lost",
    }
    ```

От клиента другому клиенту (через сервер):
сервер просто пересылает сообщение второму.

 1. custom JSON
    ```json
    {
        "msg_type" : "..etc..",
        ...
    }
    ```

 2. custom binary (flags.binary == True)

